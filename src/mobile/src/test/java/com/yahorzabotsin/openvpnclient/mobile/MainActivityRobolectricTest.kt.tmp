package com.yahorzabotsin.openvpnclient.mobile

import android.view.Gravity
import android.widget.FrameLayout
import androidx.drawerlayout.widget.DrawerLayout
import com.google.android.material.navigation.NavigationView
import com.yahorzabotsin.openvpnclient.core.R
import org.junit.Assert.assertEquals
import org.junit.Assert.assertNotNull
import org.junit.Test
import org.junit.runner.RunWith
import org.robolectric.Robolectric
import org.robolectric.RobolectricTestRunner

@RunWith(RobolectricTestRunner::class)
class MainActivityRobolectricTest {

    @Test
    fun onCreate_bindsViews_addsCenterWidget_and_setsUpDrawer() {
        val controller = Robolectric.buildActivity(MainActivity::class.java)
        val activity = controller.get()
        // Use the app theme defined in core resources
        activity.setTheme(R.style.Theme_OpenVPNClient_Base)
        controller.setup()

        val drawer = activity.findViewById<DrawerLayout>(R.id.drawer_layout)
        val nav = activity.findViewById<NavigationView>(R.id.nav_view)
        val center = activity.findViewById<FrameLayout>(R.id.main_center_container)
        val toolbar = activity.findViewById<androidx.appcompat.widget.Toolbar>(R.id.toolbar)
        val connection = activity.findViewById<com.yahorzabotsin.openvpnclient.core.ui.ConnectionControlsView>(R.id.connection_controls)

        assertNotNull(drawer)
        assertNotNull(nav)
        assertNotNull(center)
        assertNotNull(toolbar)
        assertNotNull(connection)
        // Speedometer view is added programmatically into center container
        assertEquals(true, center.childCount > 0)
    }

    @Test
    fun navigationItemClick_closesDrawer() {
        val controller = Robolectric.buildActivity(MainActivity::class.java)
        val activity = controller.get()
        activity.setTheme(R.style.Theme_OpenVPNClient_Base)
        controller.setup()

        val drawer = activity.findViewById<DrawerLayout>(R.id.drawer_layout)
        val nav = activity.findViewById<NavigationView>(R.id.nav_view)

        drawer.openDrawer(Gravity.START)
        // Simulate selecting a navigation item (e.g., server list)
        nav.menu.performIdentifierAction(R.id.nav_server, 0)
        // Listener should close the drawer
        assertEquals(false, drawer.isDrawerOpen(Gravity.START))
    }
}

