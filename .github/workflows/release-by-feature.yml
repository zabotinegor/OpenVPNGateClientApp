name: Beta Release from feature branches

on:
  push:
    branches:
      - 'feature/**'
      - 'feat/**'
  workflow_dispatch:

jobs:
  build:
    name: Beta Build & Release
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3 # –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ v4, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
      with:
        fetch-depth: 0 # –í–∞–∂–Ω–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–µ–≥–æ–≤
        fetch-tags: true # –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ç–µ–≥–æ–≤

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.x'

    - name: Install MAUI workload
      run: dotnet workload install maui

    - name: Generate beta version
      id: versioning
      shell: bash
      run: |
        set -e # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö (–∫—Ä–æ–º–µ —Ç–µ—Ö, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã || true)
        # set -e -o pipefail # –ú–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞–π–ø–ª–∞–π–Ω–æ–≤

        BRANCH="${GITHUB_REF##*/}"
        SAFE_BRANCH=$(echo "$BRANCH" | tr '/' '-' | tr '_' '-')
        echo "Branch: $BRANCH, Safe Branch: $SAFE_BRANCH"

        echo "üîç Getting latest stable tag (v8.* excluding beta)..."
        # –î–æ–±–∞–≤–ª—è–µ–º || true, —á—Ç–æ–±—ã –∫–æ–º–∞–Ω–¥–∞ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–ª–∞ —Å–∫—Ä–∏–ø—Ç, –µ—Å–ª–∏ —Ç–µ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
        STABLE_TAG=$(git tag --list 'v8.*' | grep -v 'beta' | sort -Vr | head -n 1) || true
        echo "Latest stable tag found: [$STABLE_TAG]" # [] –ø–æ–º–æ–≥—É—Ç —É–≤–∏–¥–µ—Ç—å, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –ø—É—Å—Ç–∞—è

        if [[ -z "$STABLE_TAG" ]]; then
          echo "No stable tag found, starting with 8.1.0."
          VERSION="8.1.0"
          PATCH=0 # –Ø–≤–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ç—á –≤ 0 –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
        else
          # –£–±–∏—Ä–∞–µ–º 'v' –∏ –ø–∞—Ä—Å–∏–º –≤–µ—Ä—Å–∏—é
          IFS='.' read -r MAJOR MINOR PATCH <<< "${STABLE_TAG#v}"
          echo "Parsed stable tag: MAJOR=$MAJOR, MINOR=$MINOR, PATCH=$PATCH"
          # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–∞—Ç—á –¥–ª—è –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
          PATCH=$((PATCH + 1))
          VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "Calculated next version base: $VERSION"
        fi

        echo "üîç Getting latest beta tag for v${VERSION}-${SAFE_BRANCH}-beta.* ..."
        # –î–æ–±–∞–≤–ª—è–µ–º || true –∏ –∑–¥–µ—Å—å, —Ç.–∫. –¥–ª—è –Ω–æ–≤–æ–π –í–ï–†–°–ò–ò –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å –±–µ—Ç–∞-—Ç–µ–≥–æ–≤
        BETA_TAG=$(git tag --list "v${VERSION}-${SAFE_BRANCH}-beta.*" | sort -Vr | head -n 1) || true
        echo "Latest beta tag found for this version/branch: [$BETA_TAG]"

        if [[ -n "$BETA_TAG" ]]; then
          # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –Ω–æ–º–µ—Ä –±–µ—Ç—ã (—á–∏—Å–ª–æ –ø–æ—Å–ª–µ 'beta.')
          BETA_NUM_MATCH=$(echo "$BETA_TAG" | grep -oE 'beta\.[0-9]+')
          if [[ -n "$BETA_NUM_MATCH" ]]; then
              BETA_NUM=$(echo "$BETA_NUM_MATCH" | cut -d. -f2)
              echo "Found existing beta number: $BETA_NUM"
              BETA_NUM=$((BETA_NUM + 1))
          else
              echo "Warning: Found beta tag [$BETA_TAG] but couldn't extract beta number. Starting beta from 1."
              BETA_NUM=1
          fi
        else
          echo "No existing beta tag found for v${VERSION}-${SAFE_BRANCH}. Starting beta from 1."
          BETA_NUM=1
        fi
        echo "Next beta number: $BETA_NUM"

        # –°–æ–±–∏—Ä–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–≥ –∏ –≤–µ—Ä—Å–∏—é –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        FINAL_TAG="v${VERSION}-${SAFE_BRANCH}-beta.${BETA_NUM}-auto"
        APP_VERSION="${VERSION}-${SAFE_BRANCH}-beta.${BETA_NUM}" # –í–µ—Ä—Å–∏—è –±–µ–∑ —Å—É—Ñ—Ñ–∏–∫—Å–∞ -auto

        echo "Final tag to create: $FINAL_TAG"
        echo "App version for build: $APP_VERSION"

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–∞—Ö
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "patch=$PATCH" >> $GITHUB_OUTPUT # –≠—Ç–æ—Ç patch –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –±–∞–∑–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ VERSION
        echo "tag=$FINAL_TAG" >> $GITHUB_OUTPUT
        echo "safe_branch=$SAFE_BRANCH" >> $GITHUB_OUTPUT
        echo "app_version=${APP_VERSION}" >> $GITHUB_OUTPUT

    - name: Restore dependencies
      run: dotnet restore ./src/OpenVPNClientApp.sln

    - name: Build Phone APK
      shell: bash
      run: |
        V=${{ steps.versioning.outputs.app_version }}
        P=${{ github.run_number }}
        dotnet publish src/OpenVPNClient/OpenVPNClient.Droid/OpenVPNClient.Droid.csproj \
          -f net8.0-android -c Release \
          -p:ApplicationDisplayVersion=${V} \
          -p:ApplicationVersion=${P} \
          -o output/phone

    - name: Build TV APK
      shell: bash
      run: |
        V=${{ steps.versioning.outputs.app_version }}
        P=${{ github.run_number }}
        dotnet publish src/OpenVPNClient/OpenVPNClient.Droid.TV/OpenVPNClient.Droid.TV.csproj \
          -f net8.0-android -c Release \
          -p:ApplicationDisplayVersion=${V} \
          -p:ApplicationVersion=${P} \
          -o output/tv

    - name: Rename APKs
      shell: bash
      run: |
        V=${{ steps.versioning.outputs.app_version }}
        APK_PHONE=$(find output/phone -name '*-Signed.apk' | head -n1)
        mv "$APK_PHONE" output/OpenVPNClient_Phone_${V}.apk
        APK_TV=$(find output/tv -name '*-Signed.apk' | head -n1)
        mv "$APK_TV"   output/OpenVPNClient_TV_${V}.apk

    - name: Create beta tag in Git
      # –ò—Å–ø–æ–ª—å–∑—É–µ–º actions/github-script@v6 –∏–ª–∏ v7 –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GH_PAT }} # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ GH_PAT –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        script: |
          const tag = '${{ steps.versioning.outputs.tag }}';
          const sha = context.sha;
          console.log(`Attempting to create tag: ${tag} at SHA: ${sha}`);
          try {
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${tag}`,
              sha: sha
            });
            console.log(`Successfully created tag ${tag}`);
          } catch (error) {
            // –ö–æ–¥ 422 –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Å—Å—ã–ª–∫–∞ (—Ç–µ–≥) —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (error.status === 422) {
              console.log(`‚ö†Ô∏è Tag ${tag} already exists. Skipping tag creation.`);
            } else {
              console.error(`‚ùå Failed to create tag ${tag}:`, error);
              throw error; // –ü–µ—Ä–µ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å workflow, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞ 422
            }
          }

    - name: Upload APKs to GitHub Releases (Beta)
      uses: ncipollo/release-action@v1
      with:
        token: ${{ secrets.GH_PAT }}
        tag:   ${{ steps.versioning.outputs.tag }}
        name:  "Beta Release ${{ steps.versioning.outputs.tag }}"
        body: |
          –ê–≤—Ç–æ-—Å–±–æ—Ä–∫–∞ –∏–∑ –≤–µ—Ç–∫–∏ `${{ github.ref_name }}`
          –í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: `${{ steps.versioning.outputs.app_version }}`
        prerelease: true
        allowUpdates: true
        replacesArtifacts: true
        artifacts: |
          output/OpenVPNClient_Phone_${{ steps.versioning.outputs.app_version }}.apk
          output/OpenVPNClient_TV_${{ steps.versioning.outputs.app_version }}.apk
        generateReleaseNotes: true