name: Beta Release from Feature Branch

on:
  push:
    branches:
      - 'feature/**'
      - 'feat/**'
  workflow_dispatch:

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Generate Beta Version
        id: versioning
        shell: bash
        run: |
          set -e
          BRANCH="${GITHUB_REF##*/}"
          SAFE_BRANCH=$(echo "$BRANCH" | tr '/' '-' | tr '_' '-')
          echo "==> Branch: $BRANCH"
          
          STABLE_TAG=$(git tag --list 'v8.*' | grep -v 'beta' | sort -Vr | head -n 1) || true
          if [[ -z "$STABLE_TAG" ]]; then
            echo "==> No stable tag found, starting with 1.1.0."
            VERSION="1.1.0"
            PATCH=0
          else
            IFS='.' read -r MAJOR MINOR PATCH <<< "${STABLE_TAG#v}"
            PATCH=$((PATCH + 1))
            VERSION="${MAJOR}.${MINOR}.${PATCH}"
          fi
          echo "==> Base version: $VERSION"
          
          BETA_TAG=$(git tag --list "v${VERSION}-${SAFE_BRANCH}-beta.*" | sort -Vr | head -n 1) || true
          if [[ -n "$BETA_TAG" ]]; then
            BETA_NUM_MATCH=$(echo "$BETA_TAG" | grep -oE 'beta\.[0-9]+')
            if [[ -n "$BETA_NUM_MATCH" ]]; then
                BETA_NUM=$(echo "$BETA_NUM_MATCH" | cut -d. -f2)
                BETA_NUM=$((BETA_NUM + 1))
            else
                BETA_NUM=1
            fi
          else
            BETA_NUM=1
          fi
          echo "==> Next beta number: $BETA_NUM"
          
          FINAL_TAG="v${VERSION}-${SAFE_BRANCH}-beta.${BETA_NUM}-auto"
          APP_VERSION="${VERSION}-${SAFE_BRANCH}-beta.${BETA_NUM}"
          
          echo "==> Final tag: $FINAL_TAG"
          echo "==> App version: $APP_VERSION"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "patch=$PATCH" >> $GITHUB_OUTPUT
          echo "tag=$FINAL_TAG" >> $GITHUB_OUTPUT
          echo "safe_branch=$SAFE_BRANCH" >> $GITHUB_OUTPUT
          echo "app_version=${APP_VERSION}" >> $GITHUB_OUTPUT

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
          cache-read-only: false

      - name: Make gradlew executable
        run: chmod +x gradlew
        working-directory: ./src

      - name: Build Mobile APK
        run: |
          ./gradlew :mobile:assembleRelease \
            -PappVersionName="${{ steps.versioning.outputs.app_version }}" \
            -PappVersionCode="${{ github.run_number }}"
        working-directory: ./src

      - name: Build TV APK
        run: |
          ./gradlew :tv:assembleRelease \
            -PappVersionName="${{ steps.versioning.outputs.app_version }}" \
            -PappVersionCode="${{ github.run_number }}"
        working-directory: ./src

      - name: Stage Artifacts
        shell: bash
        run: |
          V=${{ steps.versioning.outputs.app_version }}
          mkdir -p output
          APK_PHONE=$(find src/mobile/build/outputs/apk/release -name '*.apk' | head -n1)
          mv "$APK_PHONE" output/OpenVPNClient_Phone_${V}.apk
          APK_TV=$(find src/tv/build/outputs/apk/release -name '*.apk' | head -n1)
          mv "$APK_TV" output/OpenVPNClient_TV_${V}.apk

      - name: Create Git Tag
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const tag = '${{ steps.versioning.outputs.tag }}';
            const sha = context.sha;
            console.log(`Attempting to create tag: ${tag} at SHA: ${sha}`);
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tag}`,
                sha: sha
              });
              console.log(`Successfully created tag ${tag}`);
            } catch (error) {
              if (error.status === 422) {
                console.log(`Tag ${tag} already exists. Skipping tag creation.`);
              } else {
                console.error(`Failed to create tag ${tag}:`, error);
                throw error;
              }
            }

      - name: Publish Beta Release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GH_PAT }}
          tag:   ${{ steps.versioning.outputs.tag }}
          name:  "Beta Release ${{ steps.versioning.outputs.tag }}"
          body: |
            Automated build from branch `${{ github.ref_name }}`
            App version: `${{ steps.versioning.outputs.app_version }}`
          prerelease: true
          allowUpdates: true
          replacesArtifacts: true
          artifacts: |
            output/OpenVPNClient_Phone_${{ steps.versioning.outputs.app_version }}.apk
            output/OpenVPNClient_TV_${{ steps.versioning.outputs.app_version }}.apk
          generateReleaseNotes: true