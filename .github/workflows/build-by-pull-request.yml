name: PR Build Check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'src/**'
  workflow_dispatch:

concurrency:
  group: pr-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Debug APKs
    runs-on: ubuntu-latest
    env:
      ORG_GRADLE_PROJECT_PRIMARY_SERVERS_URL: ${{ vars.PRIMARY_SERVERS_URL }}
      ORG_GRADLE_PROJECT_FALLBACK_SERVERS_URL: ${{ vars.FALLBACK_SERVERS_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.GH_PAT }}

      - name: Install swig
        run: |
          sudo apt-get update
          sudo apt-get install -y swig
          swig -version

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK packages
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
        run: |
          sdkmanager --sdk_root="${ANDROID_SDK_ROOT}" \
            "platform-tools" \
            "platforms;android-36" \
            "build-tools;36.0.0" \
            "cmake;3.22.1" \
            "ndk;29.0.14206865"
          yes | sdkmanager --sdk_root="${ANDROID_SDK_ROOT}" --licenses

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
          cache-read-only: false

      - name: Make gradlew executable
        run: chmod +x gradlew
        working-directory: ./src

      - name: Run Unit Tests (core+mobile+tv, no engine)
        run: ./gradlew :core:testDebugUnitTest :mobile:testDebugUnitTest :tv:testDebugUnitTest --stacktrace
        working-directory: ./src

      - name: Upload Unit Test Reports (core)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: core-test-report
          path: |
            src/core/build/reports/tests/testDebugUnitTest/**
            src/core/build/test-results/testDebugUnitTest/**

      - name: Upload Unit Test Reports (mobile)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mobile-test-report
          path: |
            src/mobile/build/reports/tests/testDebugUnitTest/**
            src/mobile/build/test-results/testDebugUnitTest/**

      - name: Upload Unit Test Reports (tv)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tv-test-report
          path: |
            src/tv/build/reports/tests/testDebugUnitTest/**
            src/tv/build/test-results/testDebugUnitTest/**

      - name: Build Debug APKs (mobile+tv)
        run: ./gradlew :mobile:assembleDebug :tv:assembleDebug --stacktrace
        working-directory: ./src
