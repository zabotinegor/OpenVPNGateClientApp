name: Release from Tag

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest
    env:
      ORG_GRADLE_PROJECT_PRIMARY_SERVERS_URL: ${{ vars.PRIMARY_SERVERS_URL }}
      ORG_GRADLE_PROJECT_FALLBACK_SERVERS_URL: ${{ vars.FALLBACK_SERVERS_URL }}

    if: "!contains(github.ref_name, '-auto')" # Ignore tags created by other workflows

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          submodules: recursive
          token: ${{ secrets.GH_PAT }}

      - name: Install swig
        run: |
          sudo apt-get update
          sudo apt-get install -y swig
          swig -version

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Extract Version from Tag
        id: versioning
        shell: bash
        run: |
          RAW_TAG="${GITHUB_REF_NAME#v}"
          if [[ "$RAW_TAG" =~ ^(.+)\([0-9]+\)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            VERSION="${RAW_TAG}"
          fi
          RUN_BASE="${GITHUB_RUN_NUMBER:-1}"
          VERSION_CODE_MOBILE=$((RUN_BASE * 2 - 1))
          VERSION_CODE_TV=$((RUN_BASE * 2))
          LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_code_mobile=${VERSION_CODE_MOBILE}" >> $GITHUB_OUTPUT
          echo "version_code_tv=${VERSION_CODE_TV}" >> $GITHUB_OUTPUT
          echo "build_number_mobile=${VERSION_CODE_MOBILE}" >> $GITHUB_OUTPUT
          echo "build_number_tv=${VERSION_CODE_TV}" >> $GITHUB_OUTPUT
          {
            echo 'last_commit<<EOF'
            echo "$LAST_COMMIT_MSG"
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
          cache-read-only: false

      - name: Decode Keystore
        run: |
          echo "Decoding signing key..."
          echo "${{ secrets.SIGNING_KEY_BASE64 }}" | base64 --decode > keystore.jks
          
          echo "Creating keystore.properties file..."
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" > keystore.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> keystore.properties
          echo "storePassword=${{ secrets.STORE_PASSWORD }}" >> keystore.properties
          echo "storeFile=keystore.jks" >> keystore.properties
        working-directory: ./src

      - name: Make gradlew executable
        run: chmod +x gradlew
        working-directory: ./src

      - name: Stage Artifacts
        shell: bash
        run: |
          V=${{ steps.versioning.outputs.version }}
          B_MOBILE=${{ steps.versioning.outputs.build_number_mobile }}
          B_TV=${{ steps.versioning.outputs.build_number_tv }}
          ./gradlew stageReleaseArtifacts \
            -PappVersionName="${{ steps.versioning.outputs.version }}" \
            -PappVersionCodeMobile="${{ steps.versioning.outputs.version_code_mobile }}" \
            -PappVersionCodeTv="${{ steps.versioning.outputs.version_code_tv }}"
          mkdir -p ../output
          APK_MOBILE=$(find build/staged/mobile -name '*.apk' | head -n1)
          APK_TV=$(find build/staged/tv -name '*.apk' | head -n1)
          AAB_MOBILE=$(find build/staged/mobile -name '*.aab' | head -n1)
          AAB_TV=$(find build/staged/tv -name '*.aab' | head -n1)
          if [[ -n "$APK_MOBILE" ]]; then
            mv "$APK_MOBILE" "../output/OpenVPNGateClient_mobile_${V}_build${B_MOBILE}.apk"
          fi
          if [[ -n "$APK_TV" ]]; then
            mv "$APK_TV" "../output/OpenVPNGateClient_tv_${V}_build${B_TV}.apk"
          fi
          if [[ -n "$AAB_MOBILE" ]]; then
            mv "$AAB_MOBILE" "../output/OpenVPNGateClient_mobile_${V}_build${B_MOBILE}.aab"
          fi
          if [[ -n "$AAB_TV" ]]; then
            mv "$AAB_TV" "../output/OpenVPNGateClient_tv_${V}_build${B_TV}.aab"
          fi
        working-directory: ./src

      - name: Publish Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: |
            output/OpenVPNGateClient_mobile_${{ steps.versioning.outputs.version }}_build${{ steps.versioning.outputs.build_number_mobile }}.apk
            output/OpenVPNGateClient_tv_${{ steps.versioning.outputs.version }}_build${{ steps.versioning.outputs.build_number_tv }}.apk
            output/OpenVPNGateClient_mobile_${{ steps.versioning.outputs.version }}_build${{ steps.versioning.outputs.build_number_mobile }}.aab
            output/OpenVPNGateClient_tv_${{ steps.versioning.outputs.version }}_build${{ steps.versioning.outputs.build_number_tv }}.aab
          token: ${{ secrets.GH_PAT }}
          tag: ${{ github.ref_name }}
          name: "Release ${{ github.ref_name }}"
          body: |
            Automated release build for tag `${{ github.ref_name }}`
            App version: `${{ steps.versioning.outputs.version }}`
            
            What's new:
            ```
            ${{ steps.versioning.outputs.last_commit }}
            ```
          allowUpdates: true
          replacesArtifacts: true
          prerelease: false
