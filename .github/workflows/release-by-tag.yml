name: Release from Tag

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest
    env:
      ORG_GRADLE_PROJECT_PRIMARY_SERVERS_URL: ${{ vars.PRIMARY_SERVERS_URL }}
      ORG_GRADLE_PROJECT_FALLBACK_SERVERS_URL: ${{ vars.FALLBACK_SERVERS_URL }}

    if: "!contains(github.ref_name, '-auto')" # Ignore tags created by other workflows

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          submodules: recursive
          token: ${{ secrets.GH_PAT }}

      - name: Install swig
        run: |
          sudo apt-get update
          sudo apt-get install -y swig
          swig -version

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Extract Version from Tag
        id: versioning
        shell: bash
        run: |
          RAW_TAG="${GITHUB_REF_NAME#v}"
          if [[ "$RAW_TAG" =~ ^(.+)\\(([0-9]+)\\)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
            BUILD_NUMBER="${BASH_REMATCH[2]}"
          else
            VERSION="${RAW_TAG}"
            BUILD_NUMBER="${GITHUB_RUN_NUMBER:-1}"
          fi
          VERSION_CODE=${BUILD_NUMBER}
          LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_code=${VERSION_CODE}" >> $GITHUB_OUTPUT
          echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          {
            echo 'last_commit<<EOF'
            echo "$LAST_COMMIT_MSG"
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
          cache-read-only: false

      - name: Decode Keystore
        run: |
          echo "Decoding signing key..."
          echo "${{ secrets.SIGNING_KEY_BASE64 }}" | base64 --decode > keystore.jks
          
          echo "Creating keystore.properties file..."
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" > keystore.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> keystore.properties
          echo "storePassword=${{ secrets.STORE_PASSWORD }}" >> keystore.properties
          echo "storeFile=keystore.jks" >> keystore.properties
        working-directory: ./src

      - name: Make gradlew executable
        run: chmod +x gradlew
        working-directory: ./src

      - name: Build APK
        run: |
          ./gradlew assembleReleaseApp \
            -PappVersionName="${{ steps.versioning.outputs.version }}" \
            -PappVersionCode="${{ steps.versioning.outputs.version_code }}"
        working-directory: ./src

      - name: Build App Bundle (AAB)
        run: |
          ./gradlew bundleReleaseApp \
            -PappVersionName="${{ steps.versioning.outputs.version }}" \
            -PappVersionCode="${{ steps.versioning.outputs.version_code }}"
        working-directory: ./src

      - name: Stage Artifacts
        shell: bash
        run: |
          V=${{ steps.versioning.outputs.version }}
          B=${{ steps.versioning.outputs.build_number }}
          ./src/gradlew stageReleaseArtifacts \
            -PappVersionName="${{ steps.versioning.outputs.version }}" \
            -PappVersionCode="${{ steps.versioning.outputs.version_code }}"
          mkdir -p output
          APK=$(find src/build/staged -name '*.apk' | head -n1)
          mv "$APK" output/OpenVPNGateClient_${V}(${B}).apk
          AAB=$(find src/build/staged -name '*.aab' | head -n1)
          mv "$AAB" output/OpenVPNGateClient_${V}(${B}).aab

      - name: Publish Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: |
            output/OpenVPNGateClient_${{ steps.versioning.outputs.version }}(${{ steps.versioning.outputs.build_number }}).apk
            output/OpenVPNGateClient_${{ steps.versioning.outputs.version }}(${{ steps.versioning.outputs.build_number }}).aab
          token: ${{ secrets.GH_PAT }}
          tag: ${{ github.ref_name }}
          name: "Release ${{ github.ref_name }}"
          body: |
            Automated release build for tag `${{ github.ref_name }}`
            App version: `${{ steps.versioning.outputs.version }}`
            
            What's new:
            ```
            ${{ steps.versioning.outputs.last_commit }}
            ```
          allowUpdates: true
          replacesArtifacts: true
          prerelease: false
