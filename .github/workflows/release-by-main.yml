name: Release from Main

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest
    env:
      ORG_GRADLE_PROJECT_PRIMARY_SERVERS_URL: ${{ vars.PRIMARY_SERVERS_URL }}
      ORG_GRADLE_PROJECT_FALLBACK_SERVERS_URL: ${{ vars.FALLBACK_SERVERS_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Generate Version
        id: versioning
        shell: bash
        run: |
          MAJOR=1
          PATCH=$(git rev-list --count HEAD)
          VERSION="8.${MAJOR}.${PATCH}"
          TAG="v${VERSION}-auto"
          echo "==> App version: $VERSION"
          echo "==> Git tag: $TAG"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "patch=$PATCH" >> $GITHUB_OUTPUT

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
          cache-read-only: false

      - name: Decode Keystore
        run: |
          echo "Decoding signing key..."
          echo "${{ secrets.SIGNING_KEY_BASE64 }}" | base64 --decode > keystore.jks
          
          echo "Creating keystore.properties file..."
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" > keystore.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> keystore.properties
          echo "storePassword=${{ secrets.STORE_PASSWORD }}" >> keystore.properties
          echo "storeFile=keystore.jks" >> keystore.properties
        working-directory: ./src

      - name: Make gradlew executable
        run: chmod +x gradlew
        working-directory: ./src

      - name: Build Mobile APK
        run: |
          ./gradlew :mobile:assembleRelease \
            -PappVersionName="${{ steps.versioning.outputs.version }}" \
            -PappVersionCode="${{ steps.versioning.outputs.patch }}"
        working-directory: ./src

      - name: Build Mobile App Bundle (AAB)
        run: |
          ./gradlew :mobile:bundleRelease \
            -PappVersionName="${{ steps.versioning.outputs.version }}" \
            -PappVersionCode="${{ steps.versioning.outputs.patch }}"
        working-directory: ./src

      - name: Build TV APK
        run: |
          ./gradlew :tv:assembleRelease \
            -PappVersionName="${{ steps.versioning.outputs.version }}" \
            -PappVersionCode="${{ steps.versioning.outputs.patch }}"
        working-directory: ./src

      - name: Build TV App Bundle (AAB)
        run: |
          ./gradlew :tv:bundleRelease \
            -PappVersionName="${{ steps.versioning.outputs.version }}" \
            -PappVersionCode="${{ steps.versioning.outputs.patch }}"
        working-directory: ./src

      - name: Stage Artifacts
        shell: bash
        run: |
          V=${{ steps.versioning.outputs.version }}
          mkdir -p output
          APK_PHONE=$(find src/mobile/build/outputs/apk/release -name '*.apk' | head -n1)
          mv "$APK_PHONE" output/OpenVPNClient_Phone_${V}.apk
          AAB_PHONE=$(find src/mobile/build/outputs/bundle/release -name '*.aab' | head -n1)
          mv "$AAB_PHONE" output/OpenVPNGateClient_Phone_${V}.aab
          APK_TV=$(find src/tv/build/outputs/apk/release -name '*.apk' | head -n1)
          mv "$APK_TV" output/OpenVPNGateClient_TV_${V}.apk
          AAB_TV=$(find src/tv/build/outputs/bundle/release -name '*.aab' | head -n1)
          mv "$AAB_TV" output/OpenVPNGateClient_TV_${V}.aab

      - name: Create Git Tag
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const tag = '${{ steps.versioning.outputs.tag }}';
            const sha = context.sha;
            console.log(`Attempting to create tag: ${tag} at SHA: ${sha}`);
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tag}`,
                sha: sha
              });
              console.log(`Successfully created tag ${tag}`);
            } catch (error) {
              if (error.status === 422) {
                console.log(`Tag ${tag} already exists. Skipping.`);
              } else {
                throw error;
              }
            }

      - name: Publish Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: |
            output/OpenVPNGateClient_Phone_${{ steps.versioning.outputs.version }}.apk
            output/OpenVPNGateClient_Phone_${{ steps.versioning.outputs.version }}.aab
            output/OpenVPNGateClient_TV_${{ steps.versioning.outputs.version }}.apk
            output/OpenVPNGateClient_TV_${{ steps.versioning.outputs.version }}.aab
          token: ${{ secrets.GH_PAT }}
          tag: ${{ steps.versioning.outputs.tag }}
          name: "Release ${{ steps.versioning.outputs.tag }}"
          body: "Automated release build from the main branch."
          allowUpdates: true
          replacesArtifacts: true
          prerelease: false
